services:
  minio:
    image: quay.io/minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-change_this_strong_password}
      MINIO_BROWSER_REDIRECT_URL: http://localhost:9001
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./minio/data:/data
    # ❌ 删掉下面这块（minio镜像里没curl，健康检查必挂）
    # healthcheck:
    #   test: ["CMD-SHELL", "curl -fsS http://localhost:9000/minio/health/ready || exit 1"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    #   start_period: 15s

  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    depends_on:
      - minio          # ✅ 普通依赖即可，准备动作由脚本自己等待
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-change_this_strong_password}
      MINIO_BUCKET: ${MINIO_BUCKET:-tts-pipeline}
      MINIO_PUBLIC_READ: ${MINIO_PUBLIC_READ:-true}
    entrypoint: ["/bin/sh","-c"]
    command: |
      set -e
      echo '[init] alias...'
      until /usr/bin/mc alias set local http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"; do
        sleep 1
      done
      echo '[init] ensure bucket...'
      /usr/bin/mc mb -p "local/$MINIO_BUCKET" || true
      if [ "$MINIO_PUBLIC_READ" = "true" ]; then
        echo '[init] set anonymous read (download)...'
        /usr/bin/mc anonymous set download "local/$MINIO_BUCKET" || true
      fi
      if [ -f "/config/cors.json" ]; then
        echo '[init] apply CORS...'
        /usr/bin/mc cors set "local/$MINIO_BUCKET" /config/cors.json
        /usr/bin/mc cors ls "local/$MINIO_BUCKET"
      else
        echo '[init] no cors.json found, skipping CORS'
      fi
      echo '[init] done.'
    volumes:
      - ./minio/config:/config:ro
    restart: "no"